# ToO Ledger Builder

Parse target-of-opportunity (ToO) alerts from various sources, store the
resulting ToO in a database, and create an ASCII/ECSV ledger for processing ToO
secondary targets with fiberassign.

## Files

- ***toodb.py***: Encapsulation of the database for storing ToOs. The database
  is keyed by a unique TOOID.
- ***tooledger.py***: Encapsulate parsing of various ToO lists in various
  formats. This module is responsible for filling the ToO DB and subsequently
  producing a ToO ledger. Duplicate ToO IDs are not allowed.
- ***build_ledger.py***: Driver file for parsing ToO lists and converting them
  into a ledger + updated DB.

## Usage

If a ToO list is provided in `toolist.csv`, run

```
python build_ledger.py toolist.csv -o ToO-input.ecsv
```

to update the ToO database and the ASCII ToO ledger.

## Limits on ToOs

The ToO ledger used by fiberassign cannot include duplicate ToO IDs, which are
stored as 32-bit integers. The role of the TOO SQLite database defined in
`toodb.py` is to track the alerts processed by this script and ensure that
duplicate ToO IDs are not allowed.

The ToO ID is generated by taking the MJD of the alert and the number of the
alert within a given MJD as follows:

```
tooid = ((mjd - 55197) << 18) + number
```

I.e., MJD is expressed with respect to 1 Jan 2010 and is stored as a 14-bit
number. That will allow valid storage through 10 Nov 2054. The event number
within the MJD takes up the 18 least significant bits, which means we can track
up to 262144 unique alerts per night.

Encoding and decoding of the ToO ID is provided inside `toodb.py`.
